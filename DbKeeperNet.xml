<Project ToolsVersion="2.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="Properties.xml" />
  
  <PropertyGroup>
    <Name>DbKeeperNet</Name>
    <Platform>Any CPU</Platform>
    <TargetFrameworkVersion>v2.0</TargetFrameworkVersion>
    <TargetDirectoryBase>$(Name)-$(SvnBuild)</TargetDirectoryBase>
    
    <BinaryDirectory>$(TmpDir)\$(TargetDirectoryBase)</BinaryDirectory>
    <SrcDirectory>$(TmpDir)\$(TargetDirectoryBase)-src</SrcDirectory>
    <DocDirectory>$(TmpDir)\Doc</DocDirectory>

    <ChmPath>$(TmpDir)\Doc\DBKeeperNet.chm</ChmPath>
    
    <BinZipPath>$(DestinationDir)\$(Name)-$(GitBuild).zip</BinZipPath>
    <SrcZipPath>$(DestinationDir)\$(Name)-$(GitBuild)-src.zip</SrcZipPath>
    <DocZipPath>$(DestinationDir)\$(Name)-$(GitBuild)-doc.zip</DocZipPath>
  </PropertyGroup>

  <Target Name="Doc" DependsOnTargets="Build">
    <RemoveDir Directories="$(DocDirectory)" />
    <MakeDir Directories="$(DocDirectory)" />
    
    <Exec Command='"$(NDocTool)" -project=DBKeeperNet.ndoc' />
  </Target>
  
  <Target Name="Test" DependsOnTargets="Build">
    <Exec Command='"$(NUnitTool)" /labels "$(SrcRootDir)\DbKeeperNet.Engine.Tests\bin\$(Configuration)\DbKeeperNet.Engine.Tests.dll"' />
  </Target>
  <Target Name="TestMsSql" DependsOnTargets="Build">
    <Exec Command='"$(NUnitTool)" /labels /include=mssql "$(SrcRootDir)\DbKeeperNet.Engine.Tests\bin\$(Configuration)\DbKeeperNet.Engine.Tests.dll"' />
  </Target>
  <Target Name="TestMySql" DependsOnTargets="Build">
    <Exec Command='"$(NUnitTool)" /labels /include=mysql "$(SrcRootDir)\DbKeeperNet.Engine.Tests\bin\$(Configuration)\DbKeeperNet.Engine.Tests.dll"' />
  </Target>
  <Target Name="TestPgSql" DependsOnTargets="Build">
    <Exec Command='"$(NUnitTool)" /labels /include=pgsql "$(SrcRootDir)\DbKeeperNet.Engine.Tests\bin\$(Configuration)\DbKeeperNet.Engine.Tests.dll"' />
  </Target>
  <Target Name="TestSQLite" DependsOnTargets="Build">
    <Exec Command='"$(NUnitTool)" /labels /include=sqlite "$(SrcRootDir)\DbKeeperNet.Engine.Tests\bin\$(Configuration)\DbKeeperNet.Engine.Tests.dll"' />
  </Target>
  <Target Name="TestOracle" DependsOnTargets="Build">
    <Exec Command='"$(NUnitTool)" /labels /include=oracle "$(SrcRootDir)\DbKeeperNet.Engine.Tests\bin\$(Configuration)\DbKeeperNet.Engine.Tests.dll"' />
  </Target>
  <Target Name="TestFirebird" DependsOnTargets="Build">
    <Exec Command='"$(NUnitTool)" /labels /include=firebird "$(SrcRootDir)\DbKeeperNet.Engine.Tests\bin\$(Configuration)\DbKeeperNet.Engine.Tests.dll"' />
  </Target>
  <Target Name="RebuildXsd">
    <Delete Files="DbKeeperNet.Engine\XmlClasses.cs"/>
    <Copy SourceFiles="DbKeeperNet.Engine\Resources\Updates-1.0.xsd" DestinationFiles="$(TmpDir)\XmlClasses.xsd" />
    <Exec Command='"$(XsdTool)" "$(TmpDir)\XmlClasses.xsd" /n:DbKeeperNet.Engine /c /l:cs /o:DbKeeperNet.Engine' />
    
  </Target>
  <!-- Prepare ZIP file with sources for publication -->
  <Target Name="SrcZip">
    <Delete Files="$(SrcZipPath)" />
    <RemoveDir Directories="$(SrcDirectory)"/>
    
    <Exec Command='$(GitTool) clone $(GitRepository) $(SrcDirectory)'/>
    <Exec Command='$(GitTool) archive -9 -o "..\..\$(SrcZipPath)" build-$(GitBuild)' WorkingDirectory='$(SrcDirectory)'/>
    <RemoveDir Directories="$(SrcDirectory)"/>
  </Target>

  <Target Name="DocZip" DependsOnTargets="Doc">
    <Delete Files="$(DocZipPath)" />
    <Zip Files="$(ChmPath)"  ZipFileName="$(DocZipPath)" ZipLevel="9" WorkingDirectory="$(DocDirectory)" />
  </Target>


  <Target Name="BinZip" DependsOnTargets="Build">
    <RemoveDir Directories="$(BinaryDirectory)" Condition="Exists('$(BinaryDirectory)')" />
    
    <MakeDir Directories="$(BinaryDirectory)" />
    
    <Copy DestinationFolder="$(BinaryDirectory)" SourceFiles="$(SrcRootDir)\Changelog.txt" />
    <Copy DestinationFolder="$(BinaryDirectory)" SourceFiles="$(SrcRootDir)\LICENSE" />
    <Copy DestinationFolder="$(BinaryDirectory)" SourceFiles="$(SrcRootDir)\External\Log4Net.dll" />

    <!-- list of files which are part of binary package -->
    <ItemGroup>
        <BinFiles  Include="$(SrcRootDir)\DbKeeperNet.Engine\bin\$(Configuration)\**\*.dll" />
        <BinFiles  Include="$(SrcRootDir)\DbKeeperNet.Engine\bin\$(Configuration)\**\*.pdb" />
        <BinFiles  Include="$(SrcRootDir)\DbKeeperNet.Extensions.Log4Net\bin\$(Configuration)\**\*.dll" />
        <BinFiles  Include="$(SrcRootDir)\DbKeeperNet.Extensions.Log4Net\bin\$(Configuration)\**\*.pdb" />
    </ItemGroup>

    <Copy DestinationFiles="@(BinFiles->'$(BinaryDirectory)\%(RecursiveDir)%(Filename)%(Extension)')" SourceFiles="@(BinFiles)" />

    <Delete Files="$(BinZipPath)" />
    
    <ItemGroup>
        <BinZipFiles  Include="$(BinaryDirectory)\**" />
    </ItemGroup>
    
    <Zip Files="@(BinZipFiles)"  ZipFileName="$(BinZipPath)" ZipLevel="9" WorkingDirectory="$(TmpDir)" />
    
    <RemoveDir Directories="$(BinaryDirectory)" Condition="Exists('$(BinaryDirectory)')" />
  </Target>
  
  <Target Name="Packages">
    <CallTarget Targets="SrcZip" />
    <CallTarget Targets="BinZip" />
    <CallTarget Targets="DocZip" />
    
    <Message Text="New source package: $(SrcZipPath)" Importance="high" />
    <Message Text="New binary package: $(BinZipPath)" Importance="high" />
    <Message Text="New binary package: $(DocZipPath)" Importance="high" />
  </Target>
  
  <Target Name="Tests">
    <CallTarget Targets="Test" />
    <CallTarget Targets="TestMsSql" />
    <CallTarget Targets="TestMySql" />
    <CallTarget Targets="TestPgSql" />
    <CallTarget Targets="TestSQLite" />
    <CallTarget Targets="TestOracle" />
    <CallTarget Targets="TestFirebird" />
  </Target>

  <Target Name="Build" DependsOnTargets="RebuildXsd">
    <MSBuild Projects="$(SrcRootDir)\DbKeeperNet.sln" Properties='Configuration=$(Configuration);Platform=$(Platform)'/>
  </Target>
</Project>
